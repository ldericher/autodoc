#!/bin/bash

echo -n "Loading '${0}': "

#
# hard globals
#

g_bin="$(readlink -f "$(which "$0")")"
g_lib=${g_bin/"bin"/"lib"}

#
# load base program
#

source "${g_lib}/globals"
source "${g_lib}/logging"
source "${g_lib}/handle_inotify"
for plugin in "${g_lib}/plugins/"*".sh"; do
  source "${plugin}"
done

echo "program parsed."

#
# MAIN
#
echo "Building everything in '${g_watchroot}'."
do_build_all

echo "Watching '${g_watchroot}'."
# setup inotify:
#   -mrq monitor, recursive, quiet
#   -e events
#   --format %e eventlist csv, %w workdir, %f filename
inotifywait -mrq \
  -e create -e delete -e moved_to -e close_write \
  --format '%e %w%f' \
  "${g_watchroot}" | \
\
while read NOTIFICATION; do
  do_handle ${NOTIFICATION}
done
